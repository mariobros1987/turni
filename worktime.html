<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Dashboard - WorkTime</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div class="relative flex size-full min-h-screen flex-col bg-gray-50 group/design-root overflow-x-hidden" style='font-family: Manrope, "Noto Sans", sans-serif;'>
      <div class="layout-container flex h-full grow flex-col">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#eaedf1] px-10 py-3">
          <div class="flex items-center gap-4 text-[#101418]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z"
                  fill="currentColor"
                ></path>
              </svg>
            </div>
            <h2 class="text-[#101418] text-lg font-bold leading-tight tracking-[-0.015em]">WorkTime</h2>
          </div>
          <div class="flex flex-1 justify-end gap-8">
            <div class="flex items-center gap-9">
            <a class="text-[#101418] text-sm font-medium leading-normal" href="/worktime.html">Home</a>
            <a class="text-[#101418] text-sm font-medium leading-normal" href="/gestioneturni.html">Programma</a>
            <a class="text-[#101418] text-sm font-medium leading-normal" href="/orelavorate.html">Report Ore</a>
              <a class="text-[#101418] text-sm font-medium leading-normal" href="#">Impostazioni</a>
            </div>
            <button
              class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 bg-[#eaedf1] text-[#101418] gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5"
            >
              <div class="text-[#101418]" data-icon="Bell" data-size="20px" data-weight="regular">
                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                  <path
                    d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                  ></path>
                </svg>
              </div>
            </button>
            <div
              class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBJ_UBpFrnhNl-U5_4xRghmComxCZqaBPQto1Rgd1tGFNt1J1oK34gvH2r690wY3ukd8zVM_bE_C6XpOkXuXolMV7mvomwnCgoGL33L86CTYKfBorHAHx2BMu3VjuAw2g04T-wPcqU3LS4x3Av8ttTtkafnJyEJcmGzKMmSsbhdLR40dvmEo3trLni8S5WHwn0NmqXw4lwM-j5AeZxgdz3uHUqekCCsGrQbU9ilvZMF0kzc4oLfz88LnpzoYB81cNu-f02lgE9SpZY");'
            ></div>
          </div>
        </header>
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <div class="flex flex-wrap justify-between gap-3 p-4"><p class="text-[#101418] tracking-light text-[32px] font-bold leading-tight min-w-72">Bentornata, Chiara</p></div>
            <h2 class="text-[#101418] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Programma di oggi</h2>
            <div class="flex items-center gap-4 bg-gray-50 px-4 min-h-[72px] py-2">
              <div class="text-[#101418] flex items-center justify-center rounded-lg bg-[#eaedf1] shrink-0 size-12" data-icon="Clock" data-size="24px" data-weight="regular">
                <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                  <path
                    d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"
                  ></path>
                </svg>
              </div>
              <div class="flex flex-col justify-center">
                <p class="text-[#101418] text-base font-medium leading-normal line-clamp-1">Turno di lavoro</p>
                <p class="text-[#5c728a] text-sm font-normal leading-normal line-clamp-2">8:00 - 17:00</p>
              </div>
            </div>
            <h2 class="text-[#101418] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Entrata/Uscita</h2>
            <div class="flex justify-stretch">
              <div class="flex flex-1 gap-3 flex-wrap px-4 py-3 justify-between">
                <button
                  class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-5 bg-[#b2cbe5] text-[#101418] text-base font-bold leading-normal tracking-[0.015em]"
                >
                  <span class="truncate">Entrata</span>
                </button>
                <button
                  class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-5 bg-[#eaedf1] text-[#101418] text-base font-bold leading-normal tracking-[0.015em]"
                >
                  <span class="truncate">Uscita</span>
                </button>
              </div>
            </div>
            <h2 class="text-[#101418] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Attività recenti</h2>
            <div class="grid grid-cols-[40px_1fr] gap-x-2 px-4">
              <div class="flex flex-col items-center gap-1 pt-3">
                <div class="text-[#101418]" data-icon="Clock" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"
                    ></path>
                  </svg>
                </div>
                <div class="w-[1.5px] bg-[#d4dbe2] h-2 grow"></div>
              </div>
              <div class="flex flex-1 flex-col py-3">
                <p class="text-[#101418] text-base font-medium leading-normal">Uscita</p>
                <p class="text-[#5c728a] text-base font-normal leading-normal">17:00</p>
              </div>
              <div class="flex flex-col items-center gap-1">
                <div class="w-[1.5px] bg-[#d4dbe2] h-2"></div>
                <div class="text-[#101418]" data-icon="Clock" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"
                    ></path>
                  </svg>
                </div>
                <div class="w-[1.5px] bg-[#d4dbe2] h-2 grow"></div>
              </div>
              <div class="flex flex-1 flex-col py-3">
                <p class="text-[#101418] text-base font-medium leading-normal">Entrata</p>
                <p class="text-[#5c728a] text-base font-normal leading-normal">8:00</p>
              </div>
              <div class="flex flex-col items-center gap-1 pb-3">
                <div class="w-[1.5px] bg-[#d4dbe2] h-2"></div>
                <div class="text-[#101418]" data-icon="Clock" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="flex flex-1 flex-col py-3">
                <p class="text-[#101418] text-base font-medium leading-normal">Inizio turno</p>
                <p class="text-[#5c728a] text-base font-normal leading-normal">8:00</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


<script>
    document.addEventListener('DOMContentLoaded', async function() {
        const userId = localStorage.getItem('userId');
        const userData = JSON.parse(localStorage.getItem('workTimeUser'));

        if (!userId || !userData) {
            window.location.href = '/login.html'; // Ensure this is login.html, not /login
            return;
        }

        const welcomeMessage = Array.from(document.querySelectorAll('p.tracking-light')).find(p => p.textContent.includes('Bentornat'));
        if (welcomeMessage && userData.username) {
            welcomeMessage.textContent = `Bentornat${userData.role === 'female_employee_example_role' ? 'a' : 'o'}, ${userData.username}`;
        } else if (welcomeMessage && userData.email) {
             welcomeMessage.textContent = `Bentornat${userData.role === 'female_employee_example_role' ? 'a' : 'o'} (Utente ${userId})`;
        }


        const clockInButton = Array.from(document.querySelectorAll('button .truncate')).find(el => el.textContent.trim() === 'Entrata')?.closest('button');
        const clockOutButton = Array.from(document.querySelectorAll('button .truncate')).find(el => el.textContent.trim() === 'Uscita')?.closest('button');
        const recentActivityContainer = document.querySelector('.grid.grid-cols-\\[40px_1fr\\]');
        const todayScheduleContainer = Array.from(document.querySelectorAll('h2'))
            .find(h2 => h2.textContent.includes("Programma di oggi"))?.nextElementSibling;


        function showUIMessage(message, type = 'info') {
            const msgElement = document.getElementById('uiMessageArea') || document.createElement('div');
            if (!document.getElementById('uiMessageArea')) {
                msgElement.id = 'uiMessageArea';
                msgElement.style.position = 'fixed';
                msgElement.style.top = '20px';
                msgElement.style.left = '50%';
                msgElement.style.transform = 'translateX(-50%)';
                msgElement.style.padding = '10px 20px';
                msgElement.style.borderRadius = '5px';
                msgElement.style.zIndex = '1000';
                msgElement.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                document.body.appendChild(msgElement);
            }
            msgElement.textContent = message;
            msgElement.style.backgroundColor = type === 'error' ? '#f8d7da' : '#d4edda';
            msgElement.style.color = type === 'error' ? '#721c24' : '#155724';
            setTimeout(() => { msgElement.remove(); }, 3000);
            console.log(`UI Message (${type}): ${message}`);
        }

        if (clockInButton) {
            clockInButton.addEventListener('click', async () => {
                try {
                    const response = await fetch('/time_entries/clock_in', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: parseInt(userId) })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showUIMessage('Clock-in successful!');
                        fetchRecentActivity();
                    } else {
                        showUIMessage(`Clock-in failed: ${data.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    showUIMessage('Error during clock-in.', 'error');
                    console.error('Clock-in error:', error);
                }
            });
        }

        if (clockOutButton) {
            clockOutButton.addEventListener('click', async () => {
                try {
                    const response = await fetch('/time_entries/clock_out', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: parseInt(userId) })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showUIMessage('Clock-out successful!');
                        fetchRecentActivity();
                    } else {
                        showUIMessage(`Clock-out failed: ${data.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    showUIMessage('Error during clock-out.', 'error');
                    console.error('Clock-out error:', error);
                }
            });
        }

        async function fetchRecentActivity() {
            if (!recentActivityContainer) { console.log("Recent activity container not found"); return; }
            recentActivityContainer.innerHTML = '';

            try {
                const response = await fetch(`/time_entries?user_id=${userId}&_sort=clock_in_time&_order=desc&_limit=5`); // Using JSONPlaceholder-like sort/limit
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                let entries = await response.json();

                // Client-side sort if API doesn't sort perfectly or limit
                entries.sort((a,b) => new Date(b.clock_in_time) - new Date(a.clock_in_time));
                entries = entries.slice(0,5);


                if (entries.length === 0) {
                    recentActivityContainer.innerHTML = '<p class="col-span-2 text-center text-gray-500 py-4">Nessuna attività recente.</p>';
                    return;
                }

                const clockIconSvg = `
                    <div class="text-[#101418]" data-icon="Clock" data-size="24px" data-weight="regular">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"></path>
                        </svg>
                    </div>`;

                let htmlContent = '';
                entries.forEach((entry, index) => {
                    const isLastElement = index === entries.length -1;
                    const bottomLineClass = isLastElement ? 'h-0' : 'h-2 grow'; // No line for the last element

                    if (entry.clock_out_time) {
                        htmlContent += `
                            <div class="flex flex-col items-center gap-1 pt-3"> ${clockIconSvg} <div class="w-[1.5px] bg-[#d4dbe2] ${bottomLineClass}"></div> </div>
                            <div class="flex flex-1 flex-col py-3"> <p class="text-[#101418] text-base font-medium leading-normal">Uscita</p> <p class="text-[#5c728a] text-base font-normal leading-normal">${new Date(entry.clock_out_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} (${new Date(entry.date).toLocaleDateString()})</p> </div>`;
                    }
                    htmlContent += `
                        <div class="flex flex-col items-center gap-1 ${entry.clock_out_time ? '' : 'pt-3'}"> ${entry.clock_out_time ? `<div class="w-[1.5px] bg-[#d4dbe2] h-2"></div>` : ''} ${clockIconSvg} <div class="w-[1.5px] bg-[#d4dbe2] ${bottomLineClass}"></div> </div>
                        <div class="flex flex-1 flex-col py-3"> <p class="text-[#101418] text-base font-medium leading-normal">Entrata</p> <p class="text-[#5c728a] text-base font-normal leading-normal">${new Date(entry.clock_in_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} (${new Date(entry.date).toLocaleDateString()})</p> </div>`;
                });
                recentActivityContainer.innerHTML = htmlContent;

            } catch (error) {
                console.error('Failed to fetch recent activity:', error);
                recentActivityContainer.innerHTML = '<p class="col-span-2 text-center text-red-500 py-4">Errore nel caricare attività.</p>';
            }
        }

        async function fetchTodaySchedule() {
            if (!todayScheduleContainer) { console.log("Today schedule container not found"); return; }
            const scheduleTitleEl = todayScheduleContainer.querySelector('p.line-clamp-1');
            const scheduleTimeEl = todayScheduleContainer.querySelector('p.line-clamp-2');

            try {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;

                const response = await fetch(`/shifts?user_id=${userId}&year=${year}&month=${month}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const shifts = await response.json();

                const todayDateString = today.toISOString().split('T')[0];
                const todayShift = shifts.find(shift => shift.date === todayDateString);

                if (todayShift && scheduleTimeEl) {
                    if(scheduleTitleEl) scheduleTitleEl.textContent = todayShift.location ? `Turno (${todayShift.location})` : 'Turno di lavoro';
                    const startTime = new Date(`1970-01-01T${todayShift.start_time}`).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const endTime = new Date(`1970-01-01T${todayShift.end_time}`).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    scheduleTimeEl.textContent = `${startTime} - ${endTime}`;
                } else if (scheduleTimeEl) {
                     if(scheduleTitleEl) scheduleTitleEl.textContent = 'Nessun Turno';
                    scheduleTimeEl.textContent = 'Nessun turno programmato per oggi.';
                }
            } catch (error) {
                console.error('Failed to fetch today's schedule:', error);
                if (scheduleTimeEl) scheduleTimeEl.textContent = 'Errore nel caricare il programma.';
                if (scheduleTitleEl) scheduleTitleEl.textContent = 'Errore';
            }
        }

        fetchRecentActivity();
        fetchTodaySchedule();
    });
</script>
</body>
</html>
